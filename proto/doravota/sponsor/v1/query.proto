syntax = "proto3";

package doravota.sponsor.v1;

import "doravota/sponsor/v1/sponsor.proto";
import "cosmos/base/query/v1beta1/pagination.proto";
import "gogoproto/gogo.proto";
import "google/api/annotations.proto";

option go_package = "github.com/DoraFactory/doravota/x/sponsor-contract-tx/types";

// Query defines the gRPC query service for the sponsor module
service Query {
  // Sponsor queries the sponsor information for a contract
  rpc Sponsor(QuerySponsorRequest) returns (QuerySponsorResponse) {
    option (google.api.http).get = "/doravota/sponsor/v1/sponsor/{contract_address}";
  }

  // AllSponsors queries all sponsors with pagination support
  rpc AllSponsors(QueryAllSponsorsRequest) returns (QueryAllSponsorsResponse) {
    option (google.api.http).get = "/doravota/sponsor/v1/sponsors";
  }

  // UserGrantUsage queries the grant usage for a specific user and contract
  rpc UserGrantUsage(QueryUserGrantUsageRequest)
      returns (QueryUserGrantUsageResponse) {
    option (google.api.http).get = "/doravota/sponsor/v1/usage/{user_address}/{contract_address}";
  }

  // Params queries the parameters of the sponsor module
  rpc Params(QueryParamsRequest) returns (QueryParamsResponse) {
    option (google.api.http).get = "/doravota/sponsor/v1/params";
  }

  // BlockedStatus queries whether a user is globally blocked for a contract
  rpc BlockedStatus(QueryBlockedStatusRequest) returns (QueryBlockedStatusResponse) {
    option (google.api.http).get = "/doravota/sponsor/v1/blocked_status/{contract_address}/{user_address}";
  }

  // AllBlockedStatuses lists failed-attempt records with optional filtering and pagination
  rpc AllBlockedStatuses(QueryAllBlockedStatusesRequest) returns (QueryAllBlockedStatusesResponse) {
    option (google.api.http).get = "/doravota/sponsor/v1/blocked_statuses";
  }
}

// QuerySponsorRequest is the request type for the Query/Sponsor RPC method
message QuerySponsorRequest { string contract_address = 1; }

// QuerySponsorResponse is the response type for the Query/Sponsor RPC method
message QuerySponsorResponse { ContractSponsor sponsor = 1; }

// QueryAllSponsorsRequest is the request type for the Query/AllSponsors RPC
// method
message QueryAllSponsorsRequest {
  // pagination defines an optional pagination for the request.
  cosmos.base.query.v1beta1.PageRequest pagination = 1;
}

// QueryAllSponsorsResponse is the response type for the Query/AllSponsors RPC
// method
message QueryAllSponsorsResponse {
  repeated ContractSponsor sponsors = 1;
  // pagination defines the pagination in the response.
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}

// QueryUserGrantUsageRequest is the request type for the Query/UserGrantUsage
// RPC method
message QueryUserGrantUsageRequest {
  string user_address = 1;
  string contract_address = 2;
}

// QueryUserGrantUsageResponse is the response type for the Query/UserGrantUsage
// RPC method
message QueryUserGrantUsageResponse { UserGrantUsage usage = 1; }

// QueryParamsRequest is the request type for the Query/Params RPC method
message QueryParamsRequest {}

// QueryParamsResponse is the response type for the Query/Params RPC method
message QueryParamsResponse {
  // params holds all the parameters of this module.
  Params params = 1 [ (gogoproto.nullable) = false ];
}

// QueryBlockedStatusRequest is the request type for global blocked status
message QueryBlockedStatusRequest {
  string contract_address = 1;
  string user_address = 2;
}

// QueryBlockedStatusResponse contains global cooldown status and metadata
message QueryBlockedStatusResponse {
  bool blocked = 1;
  uint32 remaining_blocks = 2; // remaining blocks until unblocked
  uint32 count = 3;            // current failure count in the window
  int64 until_height = 4;      // height at which block ends
}

// BlockedStatusEntry represents one (contract,user) entry and its global cooldown status
message BlockedStatusEntry {
  string contract_address = 1;
  string user_address = 2;
  bool blocked = 3;
  uint32 remaining_blocks = 4;
  uint32 count = 5;
  int64 until_height = 6;
}

// QueryAllBlockedStatusesRequest lists all failed attempts with optional filters
message QueryAllBlockedStatusesRequest {
  string contract_address = 1; // optional: filter by contract; empty = all contracts
  bool only_blocked = 2;       // optional: return only currently blocked entries
  cosmos.base.query.v1beta1.PageRequest pagination = 3;
}

// QueryAllBlockedStatusesResponse is the response for AllBlockedStatuses
message QueryAllBlockedStatusesResponse {
  repeated BlockedStatusEntry statuses = 1;
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}
