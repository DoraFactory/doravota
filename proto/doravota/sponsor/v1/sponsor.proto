syntax = "proto3";

package doravota.sponsor.v1;

import "cosmos/base/v1beta1/coin.proto";
import "gogoproto/gogo.proto";

option go_package = "github.com/DoraFactory/doravota/x/sponsor-contract-tx/types";
option (gogoproto.equal_all) = true;

// ContractSponsor defines the sponsor information for a contract
message ContractSponsor {
  string contract_address = 1;
  // Optional custom ticket issuer. When set, only the contract admin or this
  // address is authorized to issue/revoke policy tickets for the contract.
  string ticket_issuer_address = 2;
  string creator_address = 3;  // The address that created/manages this sponsor configuration
  string sponsor_address = 4;  // The derived address that actually pays for sponsorship fees
  bool is_sponsored = 5;
  int64 created_at = 6;
  int64 updated_at = 7;
  repeated cosmos.base.v1beta1.Coin max_grant_per_user = 8;
}

// GenesisState defines the sponsor module's genesis state
message GenesisState {
  repeated ContractSponsor sponsors = 1;
  Params params = 2;
  repeated UserGrantUsage user_grant_usages = 3;
  // Outstanding policy tickets to initialize at genesis. Expired tickets may
  // also be included; they will be garbage-collected by the module's per-block
  // GC routine.
  repeated PolicyTicket policy_tickets = 4;
}

// UserGrantUsage tracks how much grant a user has used for a specific contract
message UserGrantUsage {
  string user_address = 1;
  string contract_address = 2;
  repeated cosmos.base.v1beta1.Coin total_grant_used = 3;
  int64 last_used_time = 4;
}

// Params defines the parameters for the sponsor module
message Params {
  // Whether sponsorship is globally enabled
  bool sponsorship_enabled = 1;
  // PolicyTicketTTLBlocks defines how many blocks a policy ticket remains
  // valid (short TTL encourages prompt ExecuteTx).
  // Suggested: 20-30; Range: [1, 1000].
  uint32 policy_ticket_ttl_blocks = 3;

  // Max number of CosmWasm MsgExecuteContract messages allowed in a single
  // sponsored transaction (must all target the same contract).
  uint32 max_exec_msgs_per_tx_for_sponsor = 4;

  // Max raw JSON bytes allowed per MsgExecuteContract payload to be considered
  // for sponsorship policy checks. This is a pre-parse size guard executed
  // before any JSON (un)marshalling to prevent CPU/memory amplification.
  // 0 disables this guard.
  uint32 max_policy_exec_msg_bytes = 5;

  // MaxMethodTicketUsesPerIssue caps how many uses an admin-issued method ticket
  // can have in a single issuance. The actual uses_remaining stored on the ticket
  // is min(requested_uses, max_method_ticket_uses_per_issue). Range: [1, 100] (suggested default: 3).
  uint32 max_method_ticket_uses_per_issue = 6;

  // Maximum number of expired tickets to garbage-collect per block.
  uint32 ticket_gc_per_block = 7;

  // Maximum allowed size (in bytes) for a single topâ€‘level method name
  // used in MsgExecuteContract (e.g., {"method":{...}}). This is enforced
  // when issuing method tickets and during ante parsing to avoid hashing
  // arbitrarily large keys. Range suggestion: [1, 256].
  uint32 max_method_name_bytes = 8;

  // Maximum JSON nesting depth allowed when scanning MsgExecuteContract payloads
  // to extract the top-level method key. This acts as a defensive bound against
  // deeply nested JSON intended to cause excessive decoder recursion.
  // Suggested default: 20. Reasonable range: [1, 64].
  uint32 max_method_json_depth = 9;
}

// PolicyTicket represents an authorization ticket issued by the contract admin.
// It binds (contract,user,digest) and is computed from method-level digests
// (e.g., sha256(contract || "method:" || names...)).
message PolicyTicket {
  string contract_address = 1;
  string user_address = 2;
  // Digest is computed from method names in order (method-level binding).
  string digest = 3;
  uint64 expiry_height = 4;
  // Remaining uses for this ticket (0 or 1 implies single-use semantics).
  uint32 uses_remaining = 5;
  bool consumed = 6;
  // Block height when this ticket was issued.
  uint64 issued_height = 7;
  // Optional plain-text method name for display/query convenience when the
  // ticket was issued for a single top-level method. Not used as a storage key
  // (the key remains the digest above) and may be empty when issued for
  // multiple methods.
  string method = 8;
}
