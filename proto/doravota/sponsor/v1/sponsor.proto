syntax = "proto3";

package doravota.sponsor.v1;

import "cosmos/base/v1beta1/coin.proto";

option go_package = "github.com/DoraFactory/doravota/x/sponsor-contract-tx/types";

// ContractSponsor defines the sponsor information for a contract
message ContractSponsor {
  string contract_address = 1;
  bool is_sponsored = 2;
  string creator_address = 3;  // The address that created/manages this sponsor configuration
  string sponsor_address = 4;  // The derived address that actually pays for sponsorship fees
  int64 created_at = 5;
  int64 updated_at = 6;
  repeated cosmos.base.v1beta1.Coin max_grant_per_user = 7;
}

// GenesisState defines the sponsor module's genesis state
message GenesisState {
  repeated ContractSponsor sponsors = 1;
  Params params = 2;
  repeated UserGrantUsage user_grant_usages = 3;
  // Persist global cooldown records to ensure continuity across upgrades/state-sync
  repeated FailedAttemptsEntry failed_attempts = 4;
}

// UserGrantUsage tracks how much grant a user has used for a specific contract
message UserGrantUsage {
  string user_address = 1;
  string contract_address = 2;
  repeated cosmos.base.v1beta1.Coin total_grant_used = 3;
  int64 last_used_time = 4;
}

// FailedAttempts tracks global abuse signals for sponsorship attempts
message FailedAttempts {
  // number of failed attempts within the sliding window
  uint32 count = 1;
  // window_start_height is the block height when current counting window started
  int64 window_start_height = 2;
  // until_height is the block height until which the user is globally blocked
  int64 until_height = 3;
  // last_cooldown_blocks stores the last cooldown blocks applied to support multiplicative backoff
  uint32 last_cooldown_blocks = 4;
}

// FailedAttemptsEntry binds a (contract,user) pair to its FailedAttempts data
message FailedAttemptsEntry {
  string contract_address = 1;
  string user_address = 2;
  FailedAttempts record = 3;
}

// Params defines the parameters for the sponsor module
message Params {
  // Whether sponsorship is globally enabled
  bool sponsorship_enabled = 1;

  // Maximum gas limit per sponsored transaction
  uint64 max_gas_per_sponsorship = 2;

  // Whether abuse tracking (global cooldown) is enabled
  bool abuse_tracking_enabled = 3;
  // Number of failures within window to trigger global cooldown
  uint32 global_threshold = 4;
  // Base cooldown blocks for first threshold hit
  uint32 global_base_blocks = 5;
  // Multiplicative backoff factor in milli (e.g., 3000 = 3.0x)
  uint32 global_backoff_milli = 6;
  // Max cooldown blocks cap
  uint32 global_max_blocks = 7;
  // Sliding window size for counting (blocks)
  uint32 global_window_blocks = 8;

  // Number of expired FailedAttempts entries to GC per block (deterministic EndBlock GC)
  // 0 disables automatic GC
  uint32 gc_failed_attempts_per_block = 9;
}
